# Base this image on core-image-minimal
include recipes-core/images/core-image-minimal.bb

# 488M + 20MB /boot +4MB alignment = 512M
IMAGE_ROOTFS_SIZE = "499712"

# add default password for root

ROOTFS_POSTPROCESS_COMMAND += "set_root_passwd;"
set_root_passwd() {
   ROOTPW_ENCRYPTED=""
   if [ -n "${ROOTPW}" ]; then
   ROOTPW_ENCRYPTED=`openssl passwd -crypt -quiet ${ROOTPW}`
   else
   ROOTPW_ENCRYPTED="wYNffsf6sozwE"
   fi
   sed "s%^root:[^:]*:%root:${ROOTPW_ENCRYPTED}:%" \
       < ${IMAGE_ROOTFS}/etc/shadow \
       > ${IMAGE_ROOTFS}/etc/shadow.new;
   mv ${IMAGE_ROOTFS}/etc/shadow.new ${IMAGE_ROOTFS}/etc/shadow ;
}

IMAGE_POSTPROCESS_COMMAND_coolstream-hd1 += "copy_image_hd1;"
copy_image_hd1() {
	mkdir -p ${DEPLOY_DIR_IMAGE}/flashimage/coolstream
	if [ ${IMAGETYPE} = "tiny" ]; then
	rm -rf ${DEPLOY_DIR_IMAGE}/flashimage/coolstream/*
	cp ${DEPLOY_DIR_IMAGE}/${IMAGE_NAME}.rootfs.jffs2.sum ${DEPLOY_DIR_IMAGE}/flashimage/coolstream/system.img
	cp ${DEPLOY_DIR_IMAGE}/zImage ${DEPLOY_DIR_IMAGE}/flashimage/coolstream/kernel.img
			if [ ${INCLUDE_KERNEL} = "yes" ];then
			mv ${DEPLOY_DIR_IMAGE}/flashimage/coolstream/system.img ${DEPLOY_DIR_IMAGE}/flashimage/coolstream/flashimage.img
			fi
	else rm -rf ${DEPLOY_DIR_IMAGE}/flashimage/coolstream/*
	fi
}

IMAGE_POSTPROCESS_COMMAND_coolstream-hd2 += "copy_image_hd2;"
copy_image_hd2() {
	mkdir -p ${DEPLOY_DIR_IMAGE}/flashimage;
	cp ${DEPLOY_DIR_IMAGE}/${IMAGE_NAME}.rootfs.jffs2.sum ${DEPLOY_DIR_IMAGE}/flashimage/rootfs.arm.jffs2.nand;
	cp ${DEPLOY_DIR_IMAGE}/zImage ${DEPLOY_DIR_IMAGE}/flashimage/vmlinux.ub.gz;
}

# all but not neutrino :-)
IMAGE_INSTALL += " \
    packagegroup-custom-needed \
"
# donÂ´t install kernel-modules for tiny images
IMAGE_INSTALL += "${@'kernel-modules' if IMAGETYPE != 'tiny' else ''}"

# put kernel binary into the image
IMAGE_INSTALL += "${@'' if INCLUDE_KERNEL != 'yes' else 'kernel-image'}"

EXTRAOPKGCONFIG = "neutrino-feed-config"


