From 95d0cef7c73975464e3635298d8caa268e381a5a Mon Sep 17 00:00:00 2001
From: Markus Volk <f_l_k@gmx.net>
Date: Tue, 30 Sep 2014 08:37:06 +0200
Subject: [PATCH 686/686] workaround wiped out resolv.conf at boot

Signed-off-by: Markus Volk <f_l_k@gmx.net>
---
 lib/libnet/libnet.cpp | 6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/lib/libnet/libnet.cpp b/lib/libnet/libnet.cpp
index 5af7eb7..fa12b1a 100644
--- a/lib/libnet/libnet.cpp
+++ b/lib/libnet/libnet.cpp
@@ -10,6 +10,7 @@
 #include <linux/route.h>
 
 #include "libnet.h"
+#include <cstdlib>
 
 #if 0
 //never used
@@ -232,7 +233,7 @@ void	netSetNameserver(std::string &ip)
 {
 	FILE	*fp;
 
-	fp = fopen("/etc/resolv.conf","w");
+	fp = fopen("/etc/init.d/setdns","w");
 	if (!fp)
 		return;
 
@@ -244,8 +245,9 @@ void	netSetNameserver(std::string &ip)
 #endif
 	fprintf(fp, "# generated by neutrino\n");
 	if (!ip.empty())
-		fprintf(fp,"nameserver %s\n",ip.c_str());
+		fprintf(fp,"if test -e /var/run/udhcpc.*.pid; then\necho \"udhcpc is running\"\nexit\nelse\necho \"nameserver %s\" > /etc/resolv.conf \nfi",ip.c_str());
 	fclose(fp);
+	system("chmod 755 /etc/init.d/setdns");
 }
 
 void	netGetNameserver( std::string &ip )
-- 
2.0.0.rc2

