From 0c7c9d6089df5e744d05f61b304b99d2c32b8c65 Mon Sep 17 00:00:00 2001
From: "M. Liebmann" <tuxcode.bbg@gmail.com>
Date: Wed, 25 Nov 2015 08:50:19 +0100
Subject: [PATCH 4/9] tmdb: Suppress cover flickering when scrolling

---
 src/gui/epgview.cpp | 16 ++++++++++------
 src/gui/epgview.h   |  2 +-
 2 files changed, 11 insertions(+), 7 deletions(-)

diff --git a/src/gui/epgview.cpp b/src/gui/epgview.cpp
index 02bce94..25c6244 100644
--- a/src/gui/epgview.cpp
+++ b/src/gui/epgview.cpp
@@ -219,7 +219,7 @@ void CEpgData::processTextToArray(std::string text, int screening) // UTF-8
 	addTextToArray( aktLine + aktWord, screening );
 }
 
-void CEpgData::showText( int startPos, int ypos, bool cover )
+void CEpgData::showText( int startPos, int ypos, bool cover, bool fullClear)
 {
 	// recalculate
 	medlineheight = g_Font[SNeutrinoSettings::FONT_TYPE_EPG_INFO1]->getHeight();
@@ -240,10 +240,14 @@ void CEpgData::showText( int startPos, int ypos, bool cover )
 			continue;
 		max_wday_w = std::max(max_wday_w, g_Font[SNeutrinoSettings::FONT_TYPE_EPG_INFO2]->getRenderWidth(std::string(g_Locale->getText(CLocaleManager::getWeekday(i))) + " "));
 	}
-	frameBuffer->paintBoxRel(sx, y, ox- 15, sb, COL_MENUCONTENT_PLUS_0); // background of the text box
+	int offs = fullClear ? 0 : cover_offset;
+	frameBuffer->paintBoxRel(sx+offs, y, ox-15-offs, sb, COL_MENUCONTENT_PLUS_0); // background of the text box
 	if (cover) {
-		if (!g_PicViewer->DisplayImage("/tmp/tmdb.jpg",sx+3,y+3+((sb-cover_height)/2),cover_width,cover_height, 1))
-			cover_offset = 0; }
+		if (!g_PicViewer->DisplayImage("/tmp/tmdb.jpg",sx+3,y+3+((sb-cover_height)/2),cover_width,cover_height, 1)) {
+			cover_offset = 0;
+			frameBuffer->paintBoxRel(sx, y, ox-15, sb, COL_MENUCONTENT_PLUS_0); // background of the text box
+		}
+	}
 	for (int i = startPos; i < textSize && i < startPos + medlinecount; i++, y += medlineheight)
 	{
 		if(epgText[i].second){
@@ -793,7 +797,7 @@ int CEpgData::show(const t_channel_id channel_id, uint64_t a_id, time_t* a_start
 				if (showPos+scrollCount<textCount)
 				{
 					showPos += scrollCount;
-					showText(showPos, sy + toph, tmdbtoggle);
+					showText(showPos, sy + toph, tmdbtoggle, false);
 				}
 				break;
 
@@ -802,7 +806,7 @@ int CEpgData::show(const t_channel_id channel_id, uint64_t a_id, time_t* a_start
 				if (showPos<0)
 					showPos=0;
 				else
-					showText(showPos, sy + toph, tmdbtoggle);
+					showText(showPos, sy + toph, tmdbtoggle, false);
 				break;
 			case CRCInput::RC_page_up:
 				if(isCurrentEPG(channel_id)){
diff --git a/src/gui/epgview.h b/src/gui/epgview.h
index 408b932..80b6174 100644
--- a/src/gui/epgview.h
+++ b/src/gui/epgview.h
@@ -87,7 +87,7 @@ class CEpgData
 		void GetPrevNextEPGData( uint64_t id, time_t* startzeit );
 		void addTextToArray( const std::string & text, int screening );
 		void processTextToArray(std::string text, int screening = 0);
-		void showText( int startPos, int ypos, bool cover= false );
+		void showText( int startPos, int ypos, bool cover=false, bool fullClear=true );
 		bool hasFollowScreenings(const t_channel_id channel_id, const std::string & title);
 		int FollowScreenings(const t_channel_id channel_id, const std::string & title);
 		void showTimerEventBar(bool show, bool webzap=false);
-- 
2.6.4

